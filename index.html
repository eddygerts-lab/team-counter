<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú—ã —Ç—É—Ç —Ä–∞–±–æ—Ç–∞–µ–º üöÄ</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 760px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      transition: background 0.3s, color 0.3s;
    }
    body.dark { background: #222; color: #eee; }
    .toggle-theme { float:right; margin-bottom:10px; }
    #mainTitle { text-align: center; font-size: 2.2em; font-weight: 700; margin-bottom: 8px;}
    #currentDate { text-align: center; font-size: 1.1em; margin-bottom: 25px;}
    .btn-reset { display: block; width: 100%; padding: 14px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; margin: 25px 0;}
    .item { display: flex; align-items: center; padding: 14px; border: 1px solid #e0e0e0; margin: 10px 0; border-radius: 10px; background: #f9f9f9;}
    .btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 20px; user-select: none;}
    .minus { background: #f5f5dc; color: #555; }
    .plus { background: #d5f5d5; color: #27ae60; }
    .title { flex-grow: 1; text-align: center;}
    .count { font-size: 1.3em; font-weight: bold;}
    .section-title { font-weight: bold; margin: 30px 0 12px 0; border-bottom: 1px solid #eee; padding-bottom: 6px; font-size: 1.2em;}
    .search { margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px;}
    th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: left;}
    th { background: #f5f7fa; font-weight: 600;}
    tr:nth-child(even) { background: #fcfcfc; }
    .history-table td { font-family: monospace; }
    .btn-export { margin-bottom: 10px; }
    .lunch-timers {margin-bottom:20px;}
    .lunch-item {display:flex; align-items:center; margin-bottom:6px;}
    .timer-btn {margin-left:18px; padding:4px 18px; border-radius:6px; border:1px solid #ccc; background:#d5f5d5; font-weight:bold; cursor:pointer;}
    .timer-display { margin-left:15px; font-family:monospace; min-width:90px; display:inline-block;}
    body.dark .item, body.dark table, body.dark th, body.dark td {background:#333; color:#eee; border-color:#444;}
    body.dark th {background:#444;}
    body.dark .btn-export, body.dark .timer-btn {background:#444; color:#eee;}
    body.dark .btn-reset {background:#c0392b;}
  </style>
</head>
<body>
<button class="toggle-theme" onclick="toggleTheme()">üåö/üåû</button>
<div id="mainTitle">rocketteam</div>
<div id="currentDate"></div>

<!-- –¢–∞–π–º–µ—Ä "–û–±–µ–¥" -->
<div class="section-title">üçΩÔ∏è –û–±–µ–¥ ‚Äî 60 –º–∏–Ω—É—Ç</div>
<div class="lunch-timers">
  <div class="lunch-item">–ë–æ—á–∫–∞—Ä–µ–≤ <span id="timer-bock"></span> <button class="timer-btn" onclick="startLunch('bock')">–°—Ç–∞—Ä—Ç</button></div>
  <div class="lunch-item">–ì–µ—Ä—Ü <span id="timer-gertz"></span> <button class="timer-btn" onclick="startLunch('gertz')">–°—Ç–∞—Ä—Ç</button></div>
  <div class="lunch-item">–°–æ–≥–∞–µ–≤–∞ <span id="timer-sogaeva"></span> <button class="timer-btn" onclick="startLunch('sogaeva')">–°—Ç–∞—Ä—Ç</button></div>
</div>

<div id="listClaims"></div>
<div id="listBlocks"></div>
<button class="btn-reset" onclick="resetAll()">–û–±–Ω—É–ª–∏—Ç—å –≤—Å—ë</button>

<div class="section-title">üìã –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>
<input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏..." class="search" id="historySearch" oninput="renderHistory()" />
<button class="btn-export" onclick="exportHistoryCSV()">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>

<table class="history-table">
  <thead>
    <tr>
      <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
      <th>–¢–∏–ø</th>
      <th>–ò–º—è</th>
      <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<script>
  document.getElementById('mainTitle').textContent = 'rocketteam';
  document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ru-RU', {
    day: 'numeric', month: 'long', year: 'numeric'
  });

  let data = [
    { name: "–ë–æ—á–∫–∞—Ä–µ–≤", type: "–ó–∞—è–≤–∫–∏", count: 3 },
    { name: "–ì–µ—Ä—Ü", type: "–ó–∞—è–≤–∫–∏", count: 3 },
    { name: "–°–æ–≥–∞–µ–≤–∞", type: "–ó–∞—è–≤–∫–∏", count: 3 },
    { name: "–ë–æ—á–∫–∞—Ä–µ–≤", type: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏", count: 2 },
    { name: "–ì–µ—Ä—Ü", type: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏", count: 2 },
    { name: "–°–æ–≥–∞–µ–≤–∞", type: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏", count: 2 },
  ];

  let history = JSON.parse(localStorage.getItem('counterHistory')) || [];

  function getStep(type) { return type === "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏" ? 2 : 1; }

  function resetAll() {
    if (confirm("–û–±–Ω—É–ª–∏—Ç—å –≤—Å–µ —Å—á—ë—Ç—á–∏–∫–∏?")) {
      let totalClaims = 0;
      let totalBlocks = 0;
      data.forEach(item => {
        if (item.count > 0) {
          if (item.type === "–ó–∞—è–≤–∫–∏") totalClaims += item.count;
          if (item.type === "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏") totalBlocks += item.count;
          item.count = 0;
        }
      });
      logEvent("–°–∏—Å—Ç–µ–º–∞", "", 0, `–û–±–Ω—É–ª–µ–Ω–∏–µ: –∑–∞—è–≤–∫–∏ -${totalClaims}, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ -${totalBlocks}`);
      renderCounters();
    }
  }

  function changeCount(name, type, sign) {
    const item = data.find(i => i.name === name && i.type === type);
    if (item) {
      const step = getStep(type);
      const delta = sign * step;
      item.count += delta;
      if (item.count < 0) item.count = 0;
      logEvent(type, name, delta);
      renderCounters();
    }
  }

  function logEvent(type, name = '', delta = 0, description = '') {
    const now = new Date();
    const entry = {
      display: `${now.toLocaleDateString('ru-RU',{day:'numeric',month:'long'})}, ${now.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}`,
      fullTimestamp: now.toISOString(),
      type,
      name,
      delta,
      description
    };
    history.unshift(entry);
    if (history.length > 200) history = history.slice(0, 200);
    localStorage.setItem('counterHistory', JSON.stringify(history));
    renderHistory();
  }

  function renderCounters() {
    const claims = data.filter(i => i.type === "–ó–∞—è–≤–∫–∏");
    const blocks = data.filter(i => i.type === "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏");
    const renderList = (items, containerId) => {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach(item => {
        const minusClick = `changeCount('${item.name}', '${item.type}', -1)`;
        const plusClick = `changeCount('${item.name}', '${item.type}', 1)`;
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="btn minus" onclick="${minusClick}">‚Äì</div>
          <div class="title"><strong>${item.type} ${item.name}</strong><br><span class="count">${item.count}</span></div>
          <div class="btn plus" onclick="${plusClick}">+</div>
        `;
        container.appendChild(div);
      });
    };
    renderList(claims, 'listClaims');
    renderList(blocks, 'listBlocks');
  }

  function renderHistory() {
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = '';
    let q = (document.getElementById('historySearch')?.value || '').trim().toLowerCase();
    const recent = history.slice(0, 50).filter(entry => 
      !q || [entry.type, entry.name, entry.display, entry.description, entry.delta].some(v => (v + '').toLowerCase().includes(q))
    );
    if (recent.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>';
    } else {
      recent.forEach(entry => {
        const changeText = entry.description || (entry.delta > 0 ? '+' : '') + entry.delta;
        tbody.innerHTML += `
          <tr>
            <td>${entry.display}</td>
            <td>${entry.type}</td>
            <td>${entry.name}</td>
            <td>${changeText}</td>
          </tr>
        `;
      });
    }
  }

  function exportHistoryCSV() {
    let csv = '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è,–¢–∏–ø,–ò–º—è,–ò–∑–º–µ–Ω–µ–Ω–∏–µ\n';
    history.slice(0, 50).forEach(entry => {
      const changeText = entry.description || (entry.delta > 0 ? '+' : '') + entry.delta;
      csv += `"${entry.display}","${entry.type}","${entry.name}","${changeText}"\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'history.csv';
    link.click();
  }

  // –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
  function toggleTheme() {
    document.body.classList.toggle('dark');
    localStorage.setItem("theme", document.body.classList.contains('dark') ? 'dark' : '');
  }
  if(localStorage.getItem("theme") === 'dark') document.body.classList.add('dark');

  // ------------------------------------------
  // –¢–∞–π–º–µ—Ä—ã –æ–±–µ–¥–∞ (–Ω–∞ 60 –º–∏–Ω—É—Ç)
  // ------------------------------------------

  let lunchState = JSON.parse(localStorage.getItem('lunchTimers')) || {};
  function startLunch(person) {
    lunchState[person] = Date.now();
    localStorage.setItem('lunchTimers', JSON.stringify(lunchState));
    updateLunchTimers();
  }

  function updateLunchTimers() {
    ['bock','gertz','sogaeva'].forEach(person => {
      const el = document.getElementById('timer-' + person);
      if(!lunchState[person]) { el.textContent = ''; return;}
      let msLeft = 60*60*1000 - (Date.now() - lunchState[person]);
      if (msLeft <= 0) { el.textContent = '–æ–±–µ–¥ –æ–∫–æ–Ω—á–µ–Ω'; lunchState[person]=null; localStorage.setItem('lunchTimers', JSON.stringify(lunchState)); return;}
      let min = Math.floor(msLeft/60000);
      let sec = Math.floor((msLeft%60000)/1000);
      el.textContent = '–æ—Å—Ç–∞–ª–æ—Å—å: ' + min + ' –º–∏–Ω ' + sec + ' —Å–µ–∫';
    });
  }

  setInterval(updateLunchTimers, 1000);

  renderCounters();
  renderHistory();
  updateLunchTimers();
</script>
</body>
</html>
