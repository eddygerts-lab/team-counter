<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú—ã —Ç—É—Ç –†–∞–±–æ—Ç–∞–µ–º ‚úàÔ∏è</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fff;
      margin: 0; padding: 0;
    }
    .flex-layout {
      display: flex;
      min-height: 100vh;
      max-width: 1200px;
      margin: 0 auto;
    }
    .section-left {
      flex: 1;
      min-width: 350px;
      border-right: 1px solid #e0e0e0;
      padding: 22px 24px 22px 24px;
      background: #f9f9f9;
    }
    .section-right {
      width: 420px;
      max-width: 100vw;
      padding: 22px 18px 22px 18px;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
    }
    #mainTitle {
      text-align: center;
      font-size: 2.1em;
      font-weight: 700;
      margin-bottom: 12px;
    }
    #currentDate { text-align: center; font-size: 1.05em; margin-bottom: 22px; color:#888; }
    .section-title { font-weight: bold; margin: 26px 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 4px; font-size: 1.12em;}
    .btn-reset { display: block; width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; margin: 22px 0;}
    .btn-reset:hover { background: #c0392b; }
    .item { display: flex; align-items: center; padding: 12px; border: 1px solid #e0e0e0; margin: 8px 0; border-radius: 10px; background: #fff;}
    .btn { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 19px; user-select: none;}
    .minus { background: #fde4d8; color: #555; }
    .plus { background: #d5f5d5; color: #27ae60; }
    .title { flex-grow: 1; text-align: center;}
    .count { font-size: 1.14em; font-weight: bold;}
    .lunch-timers {margin-bottom:18px;}
    .lunch-item {display:flex; align-items:center; margin-bottom:10px;}
    .timer-btn {margin-left:17px; padding:4px 20px; border-radius:5px; border:1px solid #ccc; background:#dfe9ff; font-weight:bold; cursor:pointer;}
    .timer-stop {background:#ffe1e1;}
    .timer-display { margin-left:17px; font-family:monospace; min-width:110px; display:inline-block;}
    table { width: 100%; border-collapse: collapse; margin-top: 10px;}
    th, td { border: 1px solid #ddd; padding: 9px 11px; text-align: left;}
    th { background: #f5f7fa; font-weight: 600;}
    tr:nth-child(even) { background: #fcfcfc; }
    .history-table td { font-family: monospace; }
    .search { margin-bottom: 11px; width:100%; }
    .btn-export { margin-bottom: 11px; width:100%; }
    /* Chat panel */
    .chat-panel { flex: 1; display: flex; flex-direction: column; height: 100%; }
    .chat-log {flex:1; border:1px solid #eee; border-radius:6px; background:#f7f7f7; overflow-y:auto; padding:12px; margin-bottom:8px; min-height:220px;}
    .chat-msg {margin-bottom:10px;}
    .chat-msg-me {text-align:right;}
    .chat-msg-user {font-weight:bold;}
    .chat-inputs { display: flex; gap:8px; }
    .chat-input { flex: 1; padding:8px; border-radius:6px; border:1px solid #ccc; font-size:1em;}
    .chat-send-btn { padding:9px 24px; background: #dcefff; color: #222; border: none; border-radius: 6px; cursor: pointer;}
    .chat-send-btn:hover { background:#b3daff;}
    @media (max-width: 900px) {
      .section-left, .section-right {padding:12px;}
      .flex-layout {flex-direction:column;}
      .section-right {width:100%;}
    }
  </style>
</head>
<body>
<div class="flex-layout">
<div class="section-left">
  <div id="mainTitle">–ú—ã —Ç—É—Ç –†–∞–±–æ—Ç–∞–µ–º ‚úàÔ∏è</div>
  <div id="currentDate"></div>
  
  <!-- –¢–∞–π–º–µ—Ä "–û–±–µ–¥" -->
  <div class="section-title">üçΩÔ∏è –û–±–µ–¥ ‚Äî 60 –º–∏–Ω—É—Ç</div>
  <div class="lunch-timers">
    <div class="lunch-item">–ë–æ—á–∫–∞—Ä–µ–≤
      <span id="timer-bock" class="timer-display"></span>
      <button class="timer-btn" onclick="startLunch('bock')">–°—Ç–∞—Ä—Ç</button>
      <button class="timer-btn timer-stop" onclick="stopLunch('bock')">–°—Ç–æ–ø</button>
    </div>
    <div class="lunch-item">–ì–µ—Ä—Ü
      <span id="timer-gertz" class="timer-display"></span>
      <button class="timer-btn" onclick="startLunch('gertz')">–°—Ç–∞—Ä—Ç</button>
      <button class="timer-btn timer-stop" onclick="stopLunch('gertz')">–°—Ç–æ–ø</button>
    </div>
    <div class="lunch-item">–°–æ–≥–∞–µ–≤–∞
      <span id="timer-sogaeva" class="timer-display"></span>
      <button class="timer-btn" onclick="startLunch('sogaeva')">–°—Ç–∞—Ä—Ç</button>
      <button class="timer-btn timer-stop" onclick="stopLunch('sogaeva')">–°—Ç–æ–ø</button>
    </div>
  </div>

  <div id="listClaims"></div>
  <div id="listBlocks"></div>
  <button class="btn-reset" onclick="resetAll()">–û–±–Ω—É–ª–∏—Ç—å –≤—Å—ë</button>

  <div class="section-title">üìã –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>
  <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏..." class="search" id="historySearch" oninput="renderHistory()" />
  <button class="btn-export" onclick="exportHistoryCSV()">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
  <table class="history-table">
    <thead>
      <tr>
        <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
        <th>–¢–∏–ø</th>
        <th>–ò–º—è</th>
        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>
<div class="section-right">
  <div class="section-title">üí¨ –ß–∞—Ç –∫–æ–º–∞–Ω–¥—ã</div>
  <div class="chat-panel">
    <div class="chat-log" id="chatLog"></div>
    <form class="chat-inputs" onsubmit="sendChatMsg(event)">
      <input type="text" class="chat-input" id="chatName" placeholder="–í–∞—à–µ –∏–º—è" required style="max-width:110px;">
      <input type="text" class="chat-input" id="chatText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." required>
      <button class="chat-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>
</div>
</div>
<script>
  document.getElementById('mainTitle').textContent = '–ú—ã —Ç—É—Ç –†–∞–±–æ—Ç–∞–µ–º ‚úàÔ∏è';
  document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ru-RU', { day:'numeric',month:'long',year:'numeric'});

  let data = [
    { name: "–ë–æ—á–∫–∞—Ä–µ–≤", type: "–ó–∞—è–≤–∫–∏", count: 3 },
    { name: "–ì–µ—Ä—Ü", type: "–ó–∞—è–≤–∫–∏", count: 3 },
    { name: "–°–æ–≥–∞–µ–≤–∞", type: "–ó–∞—è–≤–∫–∏", count: 3 },
    { name: "–ë–æ—á–∫–∞—Ä–µ–≤", type: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏", count: 2 },
    { name: "–ì–µ—Ä—Ü", type: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏", count: 2 },
    { name: "–°–æ–≥–∞–µ–≤–∞", type: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏", count: 2 },
  ];
  let history = JSON.parse(localStorage.getItem('counterHistory')) || [];

  function getStep(type) { return type === "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏" ? 2 : 1; }

  function resetAll() {
    if (confirm("–û–±–Ω—É–ª–∏—Ç—å –≤—Å–µ —Å—á—ë—Ç—á–∏–∫–∏?")) {
      let totalClaims = 0, totalBlocks = 0;
      data.forEach(item => {
        if (item.count > 0) {
          if (item.type === "–ó–∞—è–≤–∫–∏") totalClaims += item.count;
          if (item.type === "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏") totalBlocks += item.count;
          item.count = 0;
        }
      });
      logEvent("–°–∏—Å—Ç–µ–º–∞", "", 0, `–û–±–Ω—É–ª–µ–Ω–∏–µ: –∑–∞—è–≤–∫–∏ -${totalClaims}, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ -${totalBlocks}`);
      renderCounters();
    }
  }
  function changeCount(name, type, sign) {
    const item = data.find(i => i.name === name && i.type === type);
    if (item) {
      const step = getStep(type);
      const delta = sign * step;
      item.count += delta;
      if (item.count < 0) item.count = 0;
      logEvent(type, name, delta);
      renderCounters();
    }
  }
  function logEvent(type, name = '', delta = 0, description = '') {
    const now = new Date();
    const entry = {
      display: `${now.toLocaleDateString('ru-RU',{day:'numeric',month:'long'})}, ${now.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}`,
      fullTimestamp: now.toISOString(),
      type,
      name,
      delta,
      description
    };
    history.unshift(entry);
    if (history.length > 200) history = history.slice(0, 200);
    localStorage.setItem('counterHistory', JSON.stringify(history));
    renderHistory();
  }
  function renderCounters() {
    const claims = data.filter(i => i.type === "–ó–∞—è–≤–∫–∏");
    const blocks = data.filter(i => i.type === "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏");
    function renderList(items, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach(item => {
        const minusClick = `changeCount('${item.name}', '${item.type}', -1)`;
        const plusClick = `changeCount('${item.name}', '${item.type}', 1)`;
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="btn minus" onclick="${minusClick}">‚Äì</div>
          <div class="title"><strong>${item.type} ${item.name}</strong><br><span class="count">${item.count}</span></div>
          <div class="btn plus" onclick="${plusClick}">+</div>
        `;
        container.appendChild(div);
      });
    }
    renderList(claims, 'listClaims');
    renderList(blocks, 'listBlocks');
  }
  function renderHistory() {
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = '';
    let q = (document.getElementById('historySearch')?.value || '').trim().toLowerCase();
    const recent = history.slice(0, 50).filter(entry =>
      !q || [entry.type, entry.name, entry.display, entry.description, entry.delta].some(v => (v + '').toLowerCase().includes(q))
    );
    if (recent.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>';
    } else {
      recent.forEach(entry => {
        const changeText = entry.description || (entry.delta > 0 ? '+' : '') + entry.delta;
        tbody.innerHTML += `
          <tr>
            <td>${entry.display}</td>
            <td>${entry.type}</td>
            <td>${entry.name}</td>
            <td>${changeText}</td>
          </tr>
        `;
      });
    }
  }
  function exportHistoryCSV() {
    let csv = '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è,–¢–∏–ø,–ò–º—è,–ò–∑–º–µ–Ω–µ–Ω–∏–µ\n';
    history.slice(0, 50).forEach(entry => {
      const changeText = entry.description || (entry.delta > 0 ? '+' : '') + entry.delta;
      csv += `"${entry.display}","${entry.type}","${entry.name}","${changeText}"\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'history.csv';
    link.click();
  }
  // ---------------- –¢–∞–π–º–µ—Ä—ã –æ–±–µ–¥–∞ -------------------
  let lunchState = JSON.parse(localStorage.getItem('lunchTimers')) || {};
  function startLunch(person) {
    lunchState[person] = Date.now();
    localStorage.setItem('lunchTimers', JSON.stringify(lunchState));
    updateLunchTimers();
  }
  function stopLunch(person) {
    lunchState[person] = null;
    localStorage.setItem('lunchTimers', JSON.stringify(lunchState));
    updateLunchTimers();
  }
  function updateLunchTimers() {
    ['bock','gertz','sogaeva'].forEach(person => {
      const el = document.getElementById('timer-' + person);
      if(!lunchState[person]) { el.textContent = ''; return;}
      let msLeft = 60*60*1000 - (Date.now() - lunchState[person]);
      if(msLeft <= 0) { el.textContent = '–û–±–µ–¥ –æ–∫–æ–Ω—á–µ–Ω'; lunchState[person]=null; localStorage.setItem('lunchTimers', JSON.stringify(lunchState)); return;}
      let min = Math.floor(msLeft/60000);
      let sec = Math.floor((msLeft%60000)/1000);
      el.textContent = '–û—Å—Ç–∞–ª–æ—Å—å ' + min + ' –º–∏–Ω ' + sec + ' —Å–µ–∫';
    });
  }
  setInterval(updateLunchTimers, 1000);

  // -------------- –ß–ê–¢ --------------------
  let chatMessages = JSON.parse(localStorage.getItem('teamChatLog') || "[]");
  function renderChat() {
    const log = document.getElementById('chatLog');
    log.innerHTML = '';
    chatMessages.slice(-60).forEach(msg => {
      log.innerHTML += `<div class="chat-msg${msg.me ? ' chat-msg-me' : ''}"><span class="chat-msg-user">${msg.name}:</span> <span>${msg.text}</span></div>`;
    });
    log.scrollTop = log.scrollHeight;
  }
  function sendChatMsg(e) {
    e.preventDefault();
    let name = document.getElementById('chatName').value.trim().slice(0,20);
    let text = document.getElementById('chatText').value.trim().slice(0,100);
    if(!name || !text) return false;
    chatMessages.push({ name, text, ts:Date.now(), me:true });
    localStorage.setItem('teamChatLog', JSON.stringify(chatMessages));
    document.getElementById('chatText').value = "";
    renderChat();
    return false;
  }
  renderCounters();
  renderHistory();
  updateLunchTimers();
  renderChat();
</script>
</body>
</html>
