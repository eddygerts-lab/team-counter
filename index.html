<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú—ã —Ç—É—Ç —Ä–∞–±–æ—Ç–∞–µ–º ‚úàÔ∏è</title>
  <style>
    body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:#fff; margin:0; padding:0; }
    .dark { background:#282b30; color:#e7eaee; }
    .layout-main { display:flex; min-height:100vh; max-width:1200px; margin:0 auto; }
    .lunch-col { flex:0 0 280px; width:280px; background:#f8f9fa; border-right:1px solid #e1e1e1; padding:28px 0 18px 0; min-width:220px;}
    .center-content { flex:1; display:flex; flex-direction:column; align-items:center; padding:22px 24px 8px 24px;}
    .bottom-history { width:100%; max-width:570px; margin:38px auto 0 auto;}
    .side-right { width:276px; padding:28px 12px 16px 12px; background:#fff; border-left:1px solid #e1e1e1; display:flex; flex-direction:column;}
    #mainTitle { text-align:center; font-size:2em; font-weight:700; margin-bottom:14px;}
    #currentDate { text-align:center; font-size:1em; margin-bottom:18px; color:#888;}
    .theme-toggle-box { position:fixed; top:22px; right:34px; z-index:10; }
    .theme-btn { background:none; border:none; font-size:22px; cursor:pointer; margin:0 5px;}
    .lunch-title { font-weight:600; font-size:1.09em; margin-bottom:8px; text-align:center;}
    .lunch-item {display:flex; align-items:center; margin-bottom:16px;}
    .timer-btn {margin-left:15px; padding:4px 16px; border-radius:6px; border:1px solid #ccc; background:#dfe9ff; font-weight:bold; cursor:pointer;}
    .timer-stop {background:#ffe1e1;}
    .timer-display { margin-left:10px; font-family:monospace; min-width:108px; display:inline-block;}
    .center-title { font-weight:600; font-size:1.12em; margin-bottom:16px; }
    .item { display:flex; align-items:center; padding:13px; border:1px solid #eee; margin:8px 0; border-radius:10px; background:#fff; width:100%; max-width:510px;}
    .btn { width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; font-size:19px;user-select:none;}
    .minus { background:#fde4d8; color:#555;}
    .plus { background:#d5f5d5; color:#27ae60;}
    .title {flex-grow:1; text-align:center;}
    .count {font-size:1.11em; font-weight:bold;}
    .btn-reset { display:block; width:100%; max-width:510px; padding:13px; background:#e74c3c; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1em; margin:26px auto 9px auto; }
    .btn-reset:hover {background:#c0392b;}
    /* History */
    .history-title { font-weight:bold; margin:18px 0 8px 0; border-bottom:1px solid #eee; padding-bottom:3px; font-size:1.11em;}
    .history-table {width:100%; border-collapse:collapse; margin-top:8px;}
    th,td {border:1px solid #ddd; padding:8px 10px; text-align:left;}
    th {background:#f5f7fa; font-weight:600;}
    tr:nth-child(even){background:#fcfcfc;}
    .bottom-history input {margin-bottom:7px; width:100%; padding:6px;}
    /* Chat */
    .chat-title {font-weight:600; font-size:1.09em; margin-bottom:7px; border-bottom:1px solid #eee; padding-bottom:3px;}
    .chat-log {flex:1; border:1px solid #eee; border-radius:8px; background:#f7f7f7; overflow-y:auto; padding:7px; margin-bottom:10px; min-height:100px; max-height:210px;}
    .chat-msg {margin-bottom:7px;}
    .chat-msg-user {font-weight:600;}
    .chat-inputs {display:flex; gap:7px;}
    .chat-input {flex:1; padding:8px; border-radius:6px; border:1px solid #ccc; font-size:1em;}
    .chat-send-btn {padding:7px 16px; background:#dcefff; color:#222; border:none; border-radius:6px; cursor:pointer;}
    .chat-send-btn:hover {background:#a9dfff;}
    /* Dark mode */
    body.dark,.dark .item,.dark table,.dark th,.dark td  {background:#2b323b; color:#e7eaee; border-color:#444;}
    .dark th{background:#353c46;}
    .dark .btn-reset{background:#a9312b;}
    .dark .plus,.dark .minus{background:#353c46;}
    .dark .timer-btn,.dark .chat-send-btn{background:#353c46; color:#e7eaee;}
    .dark .history-table tr:nth-child(even){background:#23272f;}
    @media(max-width:900px){
      .layout-main{flex-direction:column;}
      .lunch-col,.side-right{width:100%;min-width:unset;}
      .bottom-history{margin-top:22px;max-width:100vw;}
      .center-content{padding:12px;}
      .item,.btn-reset{max-width:100vw;}
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="theme-toggle-box">
  <button class="theme-btn" onclick="setTheme('light')">üåû</button>
  <button class="theme-btn" onclick="setTheme('dark')">üåö</button>
</div>
<div class="layout-main">
  <div class="lunch-col">
    <div class="lunch-title">üçΩÔ∏è –û–±–µ–¥ ‚Äî 60 –º–∏–Ω—É—Ç</div>
    <div class="lunch-item">–ë–æ—á–∫–∞—Ä–µ–≤ <span id="timer-bock" class="timer-display"></span>
      <button class="timer-btn" onclick="startLunch('bock')">–°—Ç–∞—Ä—Ç</button>
      <button class="timer-btn timer-stop" onclick="stopLunch('bock')">–°—Ç–æ–ø</button>
    </div>
    <div class="lunch-item">–ì–µ—Ä—Ü <span id="timer-gertz" class="timer-display"></span>
      <button class="timer-btn" onclick="startLunch('gertz')">–°—Ç–∞—Ä—Ç</button>
      <button class="timer-btn timer-stop" onclick="stopLunch('gertz')">–°—Ç–æ–ø</button>
    </div>
    <div class="lunch-item">–°–æ–≥–∞–µ–≤–∞ <span id="timer-sogaeva" class="timer-display"></span>
      <button class="timer-btn" onclick="startLunch('sogaeva')">–°—Ç–∞—Ä—Ç</button>
      <button class="timer-btn timer-stop" onclick="stopLunch('sogaeva')">–°—Ç–æ–ø</button>
    </div>
  </div>
  <div class="center-content">
    <div id="mainTitle">–ú—ã —Ç—É—Ç –†–∞–±–æ—Ç–∞–µ–º ‚úàÔ∏è</div>
    <div id="currentDate"></div>
    <div class="center-title">–°—á–µ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã</div>
    <div id="listClaims"></div>
    <div id="listBlocks"></div>
    <button class="btn-reset" onclick="resetAll()">–û–±–Ω—É–ª–∏—Ç—å –≤—Å—ë</button>
    <div class="bottom-history">
      <div class="history-title">üìã –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>
      <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏..." id="historySearch" oninput="renderHistory()" />
      <table class="history-table">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
            <th>–¢–∏–ø</th>
            <th>–ò–º—è</th>
            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>
  <div class="side-right">
    <div class="chat-title">üí¨ –ß–∞—Ç –∫–æ–º–∞–Ω–¥—ã</div>
    <div class="chat-log" id="chatLog"></div>
    <form class="chat-inputs" onsubmit="sendChatMsg(event)">
      <input type="text" class="chat-input" id="chatName" placeholder="–í–∞—à–µ –∏–º—è" required style="max-width:95px;">
      <input type="text" class="chat-input" id="chatText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." required>
      <button class="chat-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>
</div>
<script>
  // ---- –¢–ï–ú–´ ----
  function setTheme(mode) {
    document.body.classList.toggle('dark', mode === 'dark');
    localStorage.setItem('theme', mode === 'dark' ? 'dark' : 'light');
  }
  if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
  
  document.getElementById('mainTitle').textContent = '–ú—ã —Ç—É—Ç —Ä–∞–±–æ—Ç–∞–µ–º ‚úàÔ∏è';
  document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ru-RU', {day:'numeric',month:'long',year:'numeric'});

  // ---- FIREBASE ----
  const firebaseConfig = {
    apiKey: "AIzaSyBb0uemCwfr3LpSjqCfbrPzgXMxqJo8ub0",
    authDomain: "rocketteam-counter.firebaseapp.com",
    databaseURL: "https://rocketteam-counter-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "rocketteam-counter",
    storageBucket: "rocketteam-counter.firebasestorage.app",
    messagingSenderId: "882235505564",
    appId: "1:882235505564:web:01dbef24064b0fed5a2659"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const countersRef = db.ref('counters');
  const historyRef = db.ref('history');
  const chatRef = db.ref('chat');
  const lunchRef = db.ref('lunch');

  // ---- –°–ß–Å–¢–ß–ò–ö–ò ----
  let data = [];
  countersRef.on('value', snapshot => {
    const val = snapshot.val();
    if(val){ data = Object.keys(val).map(key => Object.assign({}, val[key], {key})); renderCounters(); }
    else{ initDefaultData(); }
  });

  function initDefaultData() {
    const defaults = [
      { name: "–ë–æ—á–∫–∞—Ä–µ–≤", type: "–ó–∞—è–≤–∫–∏", count: 0 },
      { name: "–ì–µ—Ä—Ü", type: "–ó–∞—è–≤–∫–∏", count: 0 },
      { name: "–°–æ–≥–∞–µ–≤–∞", type: "–ó–∞—è–≤–∫–∏", count: 0 },
      { name: "–ë–æ—á–∫–∞—Ä–µ–≤", type: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏", count: 0 },
      { name: "–ì–µ—Ä—Ü", type: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏", count: 0 },
      { name: "–°–æ–≥–∞–µ–≤–∞", type: "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏", count: 0 }
    ];
    const updates = {};
    defaults.forEach(item => updates[getKey(item.name,item.type)] = item);
    countersRef.set(updates);
  }
  function getKey(name,type){return name+'_'+type.replace(/\s+/g,'_');}
  function getStep(type){return type==="–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏"?2:1;}
  function changeCount(name,type,sign){
    const item=data.find(i=>i.name===name && i.type===type);
    if(!item)return;
    const delta=sign*getStep(type);
    const newCount=Math.max(0,item.count+delta);
    countersRef.child(getKey(name,type)+'/count').set(newCount);
    historyRef.push({
      time: new Date().toLocaleString('ru-RU', {hour:'2-digit',minute:'2-digit',day:'numeric',month:'long'}),
      type, name, delta
    });
  }

  function resetAll(){
    if(!confirm("–û–±–Ω—É–ª–∏—Ç—å –≤—Å–µ —Å—á—ë—Ç—á–∏–∫–∏?"))return;
    const updates={}; let totalClaims=0,totalBlocks=0;
    data.forEach(item=>{
      updates[getKey(item.name,item.type)+'/count']=0;
      if(item.type==="–ó–∞—è–≤–∫–∏") totalClaims+=item.count;
      if(item.type==="–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏") totalBlocks+=item.count;
    });
    countersRef.update(updates).then(()=>{});
    historyRef.push({
      time: new Date().toLocaleString('ru-RU', {hour:'2-digit',minute:'2-digit',day:'numeric',month:'long'}),
      type:"–°–∏—Å—Ç–µ–º–∞", name:"", delta:0,
      description:`–û–±–Ω—É–ª–µ–Ω–∏–µ: –∑–∞—è–≤–∫–∏ -${totalClaims}, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ -${totalBlocks}`
    });
  }

  function renderCounters(){
    const claims=data.filter(i=>i.type==="–ó–∞—è–≤–∫–∏");
    const blocks=data.filter(i=>i.type==="–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏");
    function renderList(items,containerId){
      const container=document.getElementById(containerId);
      container.innerHTML='';
      items.forEach(item=>{
        const div=document.createElement('div');
        div.className='item';
        div.innerHTML=`
          <div class="btn minus" onclick="changeCount('${item.name}', '${item.type}', -1)">‚Äì</div>
          <div class="title"><strong>${item.type} ${item.name}</strong><br><span class="count">${item.count}</span></div>
          <div class="btn plus" onclick="changeCount('${item.name}', '${item.type}', 1)">+</div>
        `;
        container.appendChild(div);
      });
    }
    renderList(claims,'listClaims');
    renderList(blocks,'listBlocks');
  }

  // ---- –ò–°–¢–û–†–ò–Ø ----
  historyRef.limitToLast(50).on('value', snapshot => {
    const val = snapshot.val();
    const history = val ? Object.values(val).reverse() : [];
    renderHistory(history);
  });

  function renderHistory(history) {
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = '';
    let q = (document.getElementById('historySearch')?.value || '').trim().toLowerCase();
    const shown = !q ? history : history.filter(entry =>
      [entry.type, entry.name, entry.time, entry.description, entry.delta].some(v => (v + '').toLowerCase().includes(q))
    );
    if(!shown.length){
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>';
    }else{
      shown.forEach(entry=>{
        const changeText = entry.description || (entry.delta>0?'+':'')+entry.delta;
        tbody.innerHTML += `
          <tr>
            <td>${entry.time ?? ''}</td>
            <td>${entry.type ?? ''}</td>
            <td>${entry.name ?? ''}</td>
            <td>${changeText}</td>
          </tr>
        `;
      });
    }
  }

  // ---- –ß–ê–¢ ----
  chatRef.limitToLast(40).on('value', snapshot=>{
    const val=snapshot.val(),log=document.getElementById('chatLog');
    log.innerHTML='';
    if(val){
      Object.values(val).forEach(msg=>{
        log.innerHTML += `<div class="chat-msg${msg.me?' chat-msg-me':''}"><span class="chat-msg-user">${msg.name}:</span> <span>${msg.text}</span></div>`;
      });
      log.scrollTop=log.scrollHeight;
    }
  });
  function sendChatMsg(e){
    e.preventDefault();
    let name=document.getElementById('chatName').value.trim().slice(0,20);
    let text=document.getElementById('chatText').value.trim().slice(0,120);
    if(!name||!text) return false;
    chatRef.push({ name, text, ts:Date.now(), me:true });
    document.getElementById('chatText').value="";
    return false;
  }

  // ---- –û–ë–ï–î–´ ----
  lunchRef.on('value', snapshot=>{
    window.lunchState=snapshot.val()||{};
    updateLunchTimers();
  });

  function startLunch(person){
    lunchRef.child(person).set(Date.now());
  }
  function stopLunch(person){
    lunchRef.child(person).set(null);
  }
  function updateLunchTimers(){
    ['bock','gertz','sogaeva'].forEach(person=>{
      const el=document.getElementById('timer-'+person);
      const started=window.lunchState?.[person];
      if(!started){ el.textContent=''; return; }
      let msLeft=60*60*1000-(Date.now()-started);
      if(msLeft<=0){ el.textContent='–û–±–µ–¥ –æ–∫–æ–Ω—á–µ–Ω'; lunchRef.child(person).set(null); return;}
      let min=Math.floor(msLeft/60000),sec=Math.floor((msLeft%60000)/1000);
      el.textContent='–û—Å—Ç–∞–ª–æ—Å—å ' + min + ' –º–∏–Ω ' + sec + ' —Å–µ–∫';
    });
  }
  setInterval(updateLunchTimers,1000);
</script>
</body>
</html>
